angular.module('tnf-ng-app', ['ui.router', 'ngCookies', 'ngAnimate', 'vkontakteCollectorWidget'])
.factory('$uiblock',
		[
			() ->
				block = (element) ->
					element.block(
						message: '<i class="fa fa-circle-o-notch  fa-spin" style="color:#999"></i>',
						css:
							border: 'none'
							padding: '2px',
							backgroundColor: 'none'
						overlayCSS:
							backgroundColor: '#fff'
							opacity: 0.75
					)
				unblock = (element) ->
					element.unblock()

				blockPage = ->
					block($('body'))

				unBlockPage = ->
					unblock($('body'))

				block: block
				unblock: unblock
				blockPage: blockPage
				unBlockPage: unBlockPage
		]
)
.factory('$notification',
		[
			() ->
				vkContactsUploadingStarted: () ->
					toastr.warning('Сохранение контактов начато. Не закрывайте страницу, иначе собранные контакты будут утеряны',
							'TheNewFriends')
				vkContactsUploadingFinished: () ->
					toastr.success('Контакты успешно загружены. Серверная обработка контактов займет от 10 сек до 2 минут. Так что, если вы не обнаружите файл через 10 сек — не спешите скачивать контакты снова.',
							'TheNewFriends')
				vkContactsCollectingStarted: (contacts) ->
					toastr.info('Сбор контактов начат', 'TheNewFriends')
				vkContactsCollectingFinished: (contacts) ->
					toastr.info("Собрано #{contacts.length} контактов", 'TheNewFriends')
				vkContactsCountLimitExceeded: () ->
					toastr.error('Укажите источник где меньше 100,000 пользователей', 'TheNewFriends')
				vkContactsUploadingError: () ->
					toastr.error('Возникла ошибка. Попробуйте еще раз.', 'TheNewFriends')
		]
)
.run(
		[
			'$rootScope',
			'$http',
			'$notification'
			($rootScope, $http, $notification) ->
				$rootScope.$on 'vkontakteCollector:collectingStarted', (e, source) ->
					console.log(1)
					$notification.vkContactsCollectingStarted()
				$rootScope.$on 'vkontakteCollector:collectingFinished', (e, name, source, contacts) ->
					$notification.vkContactsCollectingFinished(contacts)
				$rootScope.$on 'vkontakteCollector:countLimitExceeded', (e, source) ->
					$notification.vkContactsCountLimitExceeded()
				$rootScope.$on 'vkontakteCollector:collectingFinished', (e, source_name, source_id, source_contacts) ->
					$notification.vkContactsUploadingStarted()
					$http.post(VKONTAKTE_CONTACTS_UPLOAD_PATH, {
						vk_contacts_source_name: source_name
						vk_contacts_source_identifier: source_id
						vk_contacts_json: JSON.stringify(source_contacts)
					}).then(
						() ->
							$notification.vkContactsUploadingFinished()
					,
						()->
							$notification.vkContactsUploadingError()
					)
		]
)